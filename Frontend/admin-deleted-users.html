<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deleted Users | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard.css">
    <script src="config.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <a href="index.html" class="sidebar-logo">
                <img src="logo.jpg" alt="Logo" style="width: 40px; border-radius: 50%;">
                Nutzy Craft
            </a>
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="admin-dashboard.html" class="sidebar-link">
                        <i class="fa-solid fa-grid-2"></i> Dashboard
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="admin-users.html" class="sidebar-link">
                        <i class="fa-solid fa-users"></i> Users
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="admin-deleted-users.html" class="sidebar-link active">
                        <i class="fa-solid fa-user-slash"></i> Deleted Users
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="admin-jobs.html" class="sidebar-link">
                        <i class="fa-solid fa-briefcase"></i> Jobs
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="admin-finance.html" class="sidebar-link">
                        <i class="fa-solid fa-dollar-sign"></i> Finance
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="admin-disputes.html" class="sidebar-link">
                        <i class="fa-solid fa-gavel"></i> Disputes
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="admin-support.html" class="sidebar-link">
                        <i class="fa-solid fa-headset"></i> Support
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="admin-settings.html" class="sidebar-link">
                        <i class="fa-solid fa-gear"></i> Settings
                    </a>
                </li>
            </ul>
            <div class="sidebar-user">
                <img src="https://ui-avatars.com/api/?name=Admin&background=random&color=fff" style="width: 40px; height: 40px; border-radius: 50%;">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 0.9rem;">Admin</div>
                    <div style="font-size: 0.8rem; color: #888;">Administrator</div>
                </div>
                <a href="admin-logout.html" style="color: #888;"><i class="fa-solid fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-topbar">
                <button class="sidebar-toggle-btn"><i class="fa-solid fa-bars"></i></button>
                <div>
                    <h2 style="font-size: 1.5rem;">Deleted Users</h2>
                    <p style="color: #666;">Manage soft-deleted user accounts.</p>
                </div>
            </div>

            <div class="glass-card" style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 1.2rem; margin: 0;">Soft-Deleted Accounts</h3>
                    <div style="font-size: 0.9rem; color: #666;">
                        <i class="fa-solid fa-info-circle"></i> 
                        Accounts can be restored or permanently deleted at admin discretion
                    </div>
                </div>

                <div id="loading" style="text-align: center; padding: 40px; color: #666;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <div>Loading deleted users...</div>
                </div>

                <div id="no-users" style="display: none; text-align: center; padding: 40px; color: #666;">
                    <i class="fa-solid fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 10px;"></i>
                    <div>No deleted users found</div>
                </div>

                <div id="users-table" style="display: none; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">User</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Email</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Role</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Deleted Date</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Days Ago</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await loadDeletedUsers();
        });

        async function loadDeletedUsers() {
            const loading = document.getElementById('loading');
            const noUsers = document.getElementById('no-users');
            const usersTable = document.getElementById('users-table');
            const tbody = document.getElementById('users-tbody');

            try {
                const response = await fetch(`${window.API_CONFIG.BASE_URL}/api/admin/users/deleted`);
                
                if (!response.ok) {
                    throw new Error('Failed to load deleted users');
                }

                const users = await response.json();
                
                loading.style.display = 'none';

                if (users.length === 0) {
                    noUsers.style.display = 'block';
                    return;
                }

                usersTable.style.display = 'block';
                
                tbody.innerHTML = users.map(user => {
                    const deletedDate = new Date(user.deletedAt);
                    const daysAgo = user.daysSinceDeletion;
                    const isOldEnough = daysAgo >= 30;
                    
                    return `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || 'User')}&background=random" 
                                         style="width: 35px; height: 35px; border-radius: 50%;">
                                    <div>
                                        <div style="font-weight: 600;">${user.fullName || 'Unknown'}</div>
                                        <div style="font-size: 0.8rem; color: #888;">ID: ${user.id}</div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 12px; color: #666;">${user.email}</td>
                            <td style="padding: 12px;">
                                <span class="status-badge ${user.role === 'CLIENT' ? 'status-active' : 'status-inactive'}" 
                                      style="font-size: 0.75rem; padding: 3px 8px;">
                                    ${user.role}
                                </span>
                            </td>
                            <td style="padding: 12px; color: #666;">${deletedDate.toLocaleDateString()}</td>
                            <td style="padding: 12px;">
                                <span style="color: ${daysAgo >= 30 ? '#ef4444' : '#f59e0b'}; font-weight: 600;">
                                    ${daysAgo} days
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="restoreUser(${user.id})" 
                                        class="btn btn-outline" 
                                        style="padding: 5px 12px; font-size: 0.8rem; margin-right: 5px;">
                                    <i class="fa-solid fa-undo"></i> Restore
                                </button>
                                <button onclick="permanentlyDeleteUser(${user.id}, '${user.fullName}', ${daysAgo})" 
                                        class="btn btn-primary" 
                                        style="padding: 5px 12px; font-size: 0.8rem; background: #ef4444; border-color: #ef4444;">
                                    <i class="fa-solid fa-trash"></i> Delete Forever
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading deleted users:', error);
                loading.innerHTML = `
                    <div style="color: #ef4444;">
                        <i class="fa-solid fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div>Failed to load deleted users</div>
                    </div>
                `;
            }
        }

        async function restoreUser(userId) {
            if (!confirm('Are you sure you want to restore this user account? The user will be able to log in again.')) {
                return;
            }

            try {
                const response = await fetch(`${window.API_CONFIG.BASE_URL}/api/admin/users/${userId}/restore`, {
                    method: 'PUT'
                });

                const result = await response.json();

                if (response.ok) {
                    alert('User account restored successfully!');
                    await loadDeletedUsers(); // Reload the list
                } else {
                    alert('Error: ' + (result.error || 'Failed to restore user'));
                }
            } catch (error) {
                console.error('Error restoring user:', error);
                alert('Failed to restore user account');
            }
        }

        async function permanentlyDeleteUser(userId, userName, daysAgo) {
            const message = daysAgo < 30 
                ? `WARNING: This account was deleted only ${daysAgo} days ago.\n\nAre you sure you want to PERMANENTLY delete ${userName}'s account? This action cannot be undone and will remove all associated data including jobs, proposals, and messages.`
                : `Are you sure you want to PERMANENTLY delete ${userName}'s account? This action cannot be undone and will remove all associated data including jobs, proposals, and messages.`;
            
            if (!confirm(message)) {
                return;
            }

            // Second confirmation for permanent deletion
            if (!confirm('This is your last chance. Type DELETE in the next prompt to confirm.')) {
                return;
            }

            const confirmation = prompt('Type DELETE to confirm permanent deletion:');
            if (confirmation !== 'DELETE') {
                alert('Deletion cancelled - confirmation text did not match.');
                return;
            }

            try {
                const response = await fetch(`${window.API_CONFIG.BASE_URL}/api/admin/users/${userId}/permanent`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert('User account permanently deleted.');
                    await loadDeletedUsers(); // Reload the list
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete user'));
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to permanently delete user account');
            }
        }
    </script>
</body>
</html>
