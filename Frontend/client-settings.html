<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | Nutzy Craft</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard.css">
    <script src="config.js"></script>
    <script src="script.js" defer></script>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <a href="index.html" class="sidebar-logo">
                <img src="logo.jpg" alt="Logo" style="width: 40px; border-radius: 50%;">
                Nutzy Craft
            </a>

            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="client-dashboard.html" class="sidebar-link">
                        <i class="fa-solid fa-grid-2"></i> Dashboard
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="client-my-profile.html" class="sidebar-link">
                        <i class="fa-solid fa-user"></i> My Profile
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="post-job.html" class="sidebar-link">
                        <i class="fa-solid fa-plus-circle"></i> Post a Job
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="client-my-jobs.html" class="sidebar-link">
                        <i class="fa-solid fa-briefcase"></i> My Jobs
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="find-freelancer.html" class="sidebar-link">
                        <i class="fa-solid fa-users"></i> Find Freelancers
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="client-messages.html" class="sidebar-link">
                        <i class="fa-solid fa-message"></i> Messages
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="client-settings.html" class="sidebar-link active">
                        <i class="fa-solid fa-gear"></i> Settings
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="client-support.html" class="sidebar-link">
                        <i class="fa-solid fa-headset"></i> Support
                    </a>
                </li>
            </ul>

            <div class="sidebar-user">
                <img src="https://ui-avatars.com/api/?name=User&background=D4B69D&color=fff"
                    style="width: 40px; height: 40px; border-radius: 50%;">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 0.9rem;">&nbsp;</div>
                    <div style="font-size: 0.8rem; color: #888;">&nbsp;</div>
                </div>
                <a href="logout.html" style="color: #888;"><i class="fa-solid fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Topbar -->
            <div class="dashboard-topbar">
                <button class="sidebar-toggle-btn"><i class="fa-solid fa-bars"></i></button>
                <div>
                    <h2 class="dashboard-title" style="font-size: 1.5rem;">Account Settings</h2>
                    <p style="color: #666;">Manage your profile and payment preferences.</p>
                </div>
            </div>

            <div class="glass-card" style="max-width: 800px;">
                <h3
                    style="margin-bottom: 20px; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    Company / Profile Info</h3>
                <form id="settingsForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">Company Name</label>
                            <input type="text" id="companyName" placeholder="Acme Corp"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">Contact Person</label>
                            <input type="text" id="contactPerson" placeholder="Full Name"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">Billing Address</label>
                        <input type="text" id="billingAddress" placeholder="123 Business Rd, Tech City"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">Website</label>
                        <input type="text" id="website" placeholder="https://example.com"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">Industry</label>
                        <input type="text" id="industry" placeholder="e.g. Technology, Healthcare"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">Company Description</label>
                        <textarea id="description" rows="4" placeholder="Tell us about your company..."
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit;"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">Profile Picture</label>
                            <input type="file" id="profileUpload" accept="image/*"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 5px;">
                            <input type="hidden" id="profilePictureUrl">
                            <div id="profilePreview"
                                style="width: 60px; height: 60px; background: #eee; border-radius: 50%; background-size: cover; background-position: center; border: 1px solid #ddd; display: none;">
                            </div>
                            <button type="button" id="removeProfile" class="btn btn-outline"
                                style="margin-top: 5px; font-size: 0.8rem; padding: 4px 10px; display: none; color: #e74c3c; border-color: #e74c3c;"><i
                                    class="fa-solid fa-trash"></i> Remove</button>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">Banner Image</label>
                            <input type="file" id="backgroundUpload" accept="image/*"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 5px;">
                            <input type="hidden" id="backgroundPictureUrl">
                            <div id="backgroundPreview"
                                style="width: 100%; height: 60px; background: #eee; border-radius: 8px; background-size: cover; background-position: center; border: 1px solid #ddd; display: none;">
                            </div>
                            <button type="button" id="removeBackground" class="btn btn-outline"
                                style="margin-top: 5px; font-size: 0.8rem; padding: 4px 10px; display: none; color: #e74c3c; border-color: #e74c3c;"><i
                                    class="fa-solid fa-trash"></i> Remove</button>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 25px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 8px;">Payment Method</label>
                        <div id="payment-method-container"
                            style="display: flex; gap: 10px; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                            <span style="color: #888; font-size: 0.9rem;">No payment method added.</span>
                            <button type="button" class="btn btn-outline"
                                style="margin-left: auto; font-size: 0.8rem; padding: 4px 10px;">Add</button>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const email = localStorage.getItem('loggedInEmail') || sessionStorage.getItem('loggedInEmail');

                    // Populate Form
                    fetch(`${window.API_CONFIG.BASE_URL}/api/clients/me?email=${email}`)
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(data => {
                            // Populate form with checks for nulls, inheriting User data if Client data is missing
                            const userName = (data.user && data.user.fullName) ? data.user.fullName : '';

                            document.getElementById('companyName').value = data.companyName || userName;
                            document.getElementById('contactPerson').value = data.contactPerson || userName;
                            document.getElementById('billingAddress').value = data.billingAddress || '';
                            document.getElementById('website').value = data.website || '';
                            document.getElementById('industry').value = data.industry || '';
                            document.getElementById('description').value = data.description || '';

                            document.getElementById('profilePictureUrl').value = data.profileImage || '';
                            if (data.profileImage) {
                                const preview = document.getElementById('profilePreview');
                                preview.style.backgroundImage = `url('${data.profileImage}')`;
                                preview.style.display = 'block';
                                document.getElementById('removeProfile').style.display = 'inline-block';
                            }

                            document.getElementById('backgroundPictureUrl').value = data.bannerImage || '';
                            if (data.bannerImage) {
                                const preview = document.getElementById('backgroundPreview');
                                preview.style.backgroundImage = `url('${data.bannerImage}')`;
                                preview.style.display = 'block';
                                document.getElementById('removeBackground').style.display = 'inline-block';
                            }
                        })
                        .catch(err => console.error(err));

                    // File Upload Helper
                    const uploadFile = async (file) => {
                        const formData = new FormData();
                        formData.append('file', file);
                        const res = await fetch(`${API_CONFIG.BASE_URL}/api/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        if (!res.ok) throw new Error('Upload failed');
                        return await res.text();
                    };

                    document.getElementById('profileUpload').addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Provide valid temporary preview if needed, or just show text
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                 const preview = document.getElementById('profilePreview');
                                 preview.style.backgroundImage = `url('${e.target.result}')`;
                                 preview.style.display = 'block';
                                 document.getElementById('removeProfile').style.display = 'inline-block';
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('backgroundUpload').addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const preview = document.getElementById('backgroundPreview');
                                preview.style.backgroundImage = `url('${e.target.result}')`;
                                preview.style.display = 'block';
                                document.getElementById('removeBackground').style.display = 'inline-block';
                            }
                            reader.readAsDataURL(file);
                        }
                    });

                    // Remove Handlers
                    document.getElementById('removeProfile').addEventListener('click', function () {
                        document.getElementById('profilePictureUrl').value = ''; // Assuming this hidden input holds existing/new url
                        document.getElementById('profileUpload').value = ''; 
                        document.getElementById('profilePreview').style.display = 'none';
                        this.style.display = 'none';
                    });

                    document.getElementById('removeBackground').addEventListener('click', function () {
                        document.getElementById('backgroundPictureUrl').value = '';
                        document.getElementById('backgroundUpload').value = '';
                        document.getElementById('backgroundPreview').style.display = 'none';
                        this.style.display = 'none';
                    });

                    // Handle Submit
                    document.getElementById('settingsForm').addEventListener('submit', async function (e) {
                        e.preventDefault();
                        
                        let profileUrl = null;
                        let bannerUrl = null;
                        
                        try {
                            // Check if new file selected for Profile
                            const profileInput = document.getElementById('profileUpload');
                            if (profileInput.files.length > 0) {
                                const btn = document.querySelector('button[type="submit"]');
                                btn.textContent = 'Uploading...';
                                btn.disabled = true;
                                profileUrl = await uploadFile(profileInput.files[0]);
                            } else {
                                // Use existing if not removed
                                profileUrl = document.getElementById('profilePictureUrl').value;
                            }
                            
                            // Check if new file selected for Banner
                            const bannerInput = document.getElementById('backgroundUpload');
                            if (bannerInput.files.length > 0) {
                                const btn = document.querySelector('button[type="submit"]');
                                btn.textContent = 'Uploading...';
                                btn.disabled = true;
                                bannerUrl = await uploadFile(bannerInput.files[0]);
                            } else {
                                bannerUrl = document.getElementById('backgroundPictureUrl').value;
                            }

                        } catch(err) {
                             console.error("Error uploading", err);
                             alert("Error uploading images.");
                             document.querySelector('button[type="submit"]').textContent = 'Save Changes';
                             document.querySelector('button[type="submit"]').disabled = false;
                             return;
                        }

                        const formData = {
                            companyName: document.getElementById('companyName').value,
                            contactPerson: document.getElementById('contactPerson').value,
                            billingAddress: document.getElementById('billingAddress').value,
                            website: document.getElementById('website').value,
                            industry: document.getElementById('industry').value,
                            description: document.getElementById('description').value,
                            profileImage: profileUrl,
                            bannerImage: bannerUrl
                        };

                        fetch(`${window.API_CONFIG.BASE_URL}/api/clients/me?email=${email}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        })
                            .then(res => res.json())
                            .then(data => {
                                alert("Settings updated successfully!");
                                window.location.reload();
                            })
                            .catch(err => {
                                console.error(err);
                                alert("Failed to update settings.");
                                document.querySelector('button[type="submit"]').textContent = 'Save Changes';
                                document.querySelector('button[type="submit"]').disabled = false;
                            });
                    });
                });
            </script>

        </main>
    </div>

</body>

</html>